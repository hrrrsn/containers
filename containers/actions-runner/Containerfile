FROM registry-cdn.hpg.nz/redhat/ubi10/podman:10.0-1762805712@sha256:ad4d6403320d622d436632cb3d1eee7b4b569e41bbdd973a90fcfa177add9250

COPY start.sh start.sh

RUN yum upgrade -y && \
    yum install -y wget jq rsync git make nodejs procps-ng && \

    curl https://api.github.com/repos/actions/runner/releases/latest | jq -r '.tag_name' | sed 's/v//' > /etc/runner-version && \
    RUNNER_VERSION=$(cat /etc/runner-version) && \

    mkdir -p /home/podman/actions-runner && \
    cd /home/podman/actions-runner && \
    curl -O -L https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    tar xzf ./actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    rm -f ./actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    /home/podman/actions-runner/bin/installdependencies.sh && \

    yum clean all -y && \
    chmod +x /start.sh && \

    sed -i 's/driver = "overlay"/driver = "vfs"/g' /etc/containers/storage.conf && \

    for dir in /home/podman/actions-runner; do \
        chown -R podman:podman $dir; \
    done

ENTRYPOINT ["./start.sh"]